name: ReVanced Builder

on:
  schedule:
    - cron: '0 0 * * *' # Daily build
  workflow_dispatch:
    inputs:
      app:
        description: 'App to build (comma-separated)'
        required: false
        default: 'all'
      force:
        description: 'Force rebuild'
        required: false
        default: 'false'

env:
  CONFIG_DIR: configs
  DOWNLOAD_DIR: downloads
  DIST_DIR: dist

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'zulu'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.DOWNLOAD_DIR }}
          ${{ env.DIST_DIR }}
        key: ${{ runner.os }}-apks-${{ hashFiles('configs/*.yaml') }}
        
    - name: Download APKs
      run: |
        pip install pyyaml
        python scripts/downloader.py
        
    - name: Merge split APKs
      run: |
        wget https://github.com/REAndroid/APKEditor/releases/latest/download/APKEditor.jar
        python scripts/merger.py
        
    - name: Apply ReVanced patches
      run: |
        mkdir -p ${{ env.DIST_DIR }}
        wget -q https://github.com/anddea/revanced-patches/releases/latest/download/patches.rvp
        wget -q https://github.com/inotia00/revanced-cli/releases/latest/download/revanced-cli-all.jar
        
        # Get version info from lockfile
        versions=$(python -c "import yaml;print(yaml.safe_load(open('versions.lock'))['${{ inputs.app }}']['apk_version'])")
        app_version=$(echo $versions | cut -d' ' -f1)
        patch_version=$(echo $versions | cut -d' ' -f2)
        
        python scripts/patcher.py --version $app_version --patch-version $patch_version
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: patched-apks
        path: ${{ env.DIST_DIR }}/*.apk
        
    - name: Create release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        files: ${{ env.DIST_DIR }}/*.apk
        tag_name: patched-${{ github.run_id }}
        generate_release_notes: true

    - name: Load build rules
      id: build-rules
      run: |
        retention_days=$(python -c "import yaml; print(yaml.safe_load(open('configs/build_rules.yaml'))['global']['retention_days'])")
        echo "retention_days=$retention_days" >> $GITHUB_OUTPUT

    - name: Cleanup old artifacts
      uses: c-hive/gha-remove-artifacts@v1
      with:
        age: ${{ steps.build-rules.outputs.retention_days }} days
        skip: latest

    - name: Check for updates
      id: version-check
      run: |
        python scripts/version_check.py
        updates=$(jq -r '. | length' versions.json)
        echo "updates_found=$updates" >> $GITHUB_OUTPUT

    - name: Build components
      if: steps.version-check.outputs.updates_found > 0 || inputs.force == 'true'
      run: |
        # Existing build steps 